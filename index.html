<!DOCTYPE html>
<html lang="en-US">


<head>
	<title>TestMyBrain Norms</title>
</head>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>

<script>

$(document).ready(function() {
	$.get(dropbox_link, function(data){
        norm_data = data;
        
        //determine number of rows in CSV file
        nRow = -1;
        var i = 0;
		while(i >= 0) {
     	  i = norm_data.indexOf('\n', i+1);
     	  nRow++;
		}


        tst = norm_data.indexOf('\n');
        if (tst == -1){
			norm_data = norm_data.replace(/\r/g, ",");
		} else {
			norm_data = norm_data.replace(/\n/g, ",");
		}
		norm_data = norm_data.split(',');
		
		//get rid of weird slashes
		for (i = 0; i < norm_data.length; i++){
			norm_data[i] = norm_data[i].substr(1, norm_data[i].length - 2);
		}
		
		//find gender, age, and education columns
		gender_column = norm_data.indexOf('gender')
		age_column = norm_data.indexOf('age')
		edu_column = norm_data.indexOf('education')
		
		
		//split norm data into columns (rounding because off by 1 for some reason)
		nCol = Math.round(norm_data.length/nRow);
		for (c = 0; c < nCol; c++){
			norm_final[c] = [];
		}
		for (i = nCol; i < norm_data.length; i++){
			norm_final[i%nCol].push(norm_data[i]);
		}
		
		//get edu options (in order from csv)
		edu_options = Array.from(new Set(norm_final[edu_column]))
		for (i = 0; i < edu_options.length; i++){
			if (edu_options[i].length == 0){
				edu_options.splice(i,1);
			}
		}
		
		//get age options (in order from csv)
		age_options = Array.from(new Set(norm_final[age_column]))
		for (i = 0; i < age_options.length; i++){
			if (age_options[i].length == 0){
				age_options.splice(i,1);
			}
		}
		
		//add education and age options as menu items
		for (i = 0; i < edu_options.length; i++){
			$('#edu').append(new Option(edu_options[i],edu_options[i]));
		}
		for (i = 0; i < age_options.length; i++){
			$('#age').append(new Option(age_options[i],age_options[i]));
		}
	});
});

var dropbox_link = 'https://dl.dropboxusercontent.com/s/324v51d781prxll/adult_norms.csv?raw=1';
var norm_data = [];
var norm_final = [];
var nRow = [];
var nCol = [];
var age_column = [];
var edu_column = [];
var gender_column = [];

function getData(){
	gender = frm.gender.value;
	age = frm.age.value;
	edu = frm.edu.value;
	
	//get gender matches
	var i = 0;
	gender_match = [];
	while(i >= 0) {
     	i = norm_final[gender_column].indexOf(gender, i);
     	if (i >= 0){
     		gender_match.push(i);
     		i++;
     	}
	}
	
	//get age matches
	var i = 0;
	age_match = [];
	while(i >= 0) {
     	i = norm_final[age_column].indexOf(age, i);
     	if (i >= 0){
     		age_match.push(i);
     		i++;
     	}
	}
	
	//get edu matches
	var i = 0;
	edu_match = [];
	while(i >= 0) {
     	i = norm_final[edu_column].indexOf(edu, i);
     	if (i >= 0){
     		edu_match.push(i);
     		i++;
     	}
	}
	
	all_match = edu_match.filter(value => -1 !== gender_match.indexOf(value));
	all_match = all_match.filter(value => -1 !== age_match.indexOf(value));
	
	MakeTable();
}

function MakeTable(){
	//create table
	$("#main_table").html("");
	$('#main_table').append( '<table>');
		$('#main_table').append( '<tr>');
		for (var i = 1; i<nCol; i++){
			$('#main_table').append('<th>' + norm_data[i] +'</th>');
		} 
		$('#main_table').append( '</tr>');
		
		for (var r = 0; r < all_match.length; r++){
			$('#main_table').append( '<tr>')
				for (var c = 1; c < nCol; c++){
					$('#main_table').append( '<td>' + norm_final[c][all_match[r]] + '</td>')
				}
			$('#main_table').append( '<tr>')
		}
		$('#main_table').append(  '</table>' );
}

function clearTable(){
	$("#main_table").html("");
}

</script>

<style>
table {
    width: 100%;
    border-collapse: collapse;
    border-spacing: 0;
}
td {
text-align:center;
font-size: 12px;
padding: 4px;
border: .5px solid #000;
 white-space: nowrap;
  overflow: hidden;
}

th {
text-align:center;
font-size: 12px;
padding: 4px;
border: .5px solid #000;
 white-space: nowrap;
  overflow: hidden;
}
</style>

<body>

<div id = "instructions">Please select participant characteristics from the dropdown menu.</div>
<br>
<div id = "dropdown">
<div id = "form_div">
<form id="frm" onsubmit="getData()">
  <label for="gender">Gender:</label>
  <select id="gender" name="gender" onchange="clearTable()">
    <option value="F">Female</option>
    <option value="M">Male</option>
  </select>
  <br>
  <label for="age">Age:</label>
  <select id="age" name="age" onchange="clearTable()">
  </select>
  <br>
  <label for="edu">Years of Education:</label>
  <select id="edu" name="edu" onchange="clearTable()">
  </select>
  <br>
</form></div>
<br>
<div id="button"><button id ="main_button" onclick="getData()">Get Norm Data</button></div>
</div>

<br>
<div id="main_table"></div>
</body>
</html>
